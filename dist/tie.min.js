/*!
 TieJS - https://georghenkel.github.io/tiejs/
 Licensed under the MIT license
 Copyright (c) 2018 Georg Leber <g.leber@cg-solutions.de>, Christoph Huppertz <c.huppertz@cg-solutions.de>
 */
!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery"],e):e(jQuery)}(function($){"use strict";var TieJS=function(form,options){var self=$(this),$form=$(form),fieldNames=[],settings=$.extend({showRequiredAsterisk:!0,requiredText:"Mit <span class='required-sign'>*</span> markierte Felder sind Pflichtfelder.",formName:null,validationEnabled:!0,globalValidationFailedText:"Bitte beheben Sie die im Formular hervorgehobenen Fehler.",bindingSource:{},onSubmit:function(){}},options);function _initForm(){var e;settings.formName&&$form.attr("name",settings.formName),settings.showRequiredAsterisk&&(e=$("<p class='required-info'>"+settings.requiredText+"</p>"),$form.prepend(e)),$form.addClass("tiejs-form"),$form.on("submit",function(e){e.preventDefault(),_validate($form,fieldNames)&&settings.onSubmit($form)})}_initForm(),this.addFields=function(e){return $.each(e,function(e,a){a.data&&($form.append(_addField(a.type,a.data)),null===_findInArray(a.data.name,fieldNames)&&fieldNames.push({name:a.data.name,binding:""}))}),this},this.addColumns=function(e){return 0<e.length&&$form.append(_addColumns(e,fieldNames)),this},this.addBindings=function(bindings){return settings.bindingSource&&$.each(bindings,function(index,binding){$.each(binding,function(fieldName,property){var binding=settings.bindingSource,lastPointIdx,namespace,tmp,binding,fieldNameData=(-1!=property.indexOf(".")&&(lastPointIdx=property.lastIndexOf("."),namespace=property.substr(0,lastPointIdx),property=property.substr(lastPointIdx+1),tmp="settings.bindingSource."+namespace,binding=eval(tmp)),_bind($form,binding,fieldName,property),_findInArray(fieldName,fieldNames));fieldNameData.binding=property})}),this},this.captureFields=function(){return $form.find(":input:not(:button)").each(function(e,a){a=$(a).attr("name");null===_findInArray(a,fieldNames)&&fieldNames.push({name:a,binding:""})}),this},this.updateSettings=function(e){$.extend(settings,e),this.reload()},this.reload=function(){_clearMarker($form),$.each(fieldNames,function(e,a){_bind($form,settings.bindingSource,a.name,a.binding)})},this.markFieldError=function(e,a){$.each(e,function(e,a){_addFieldError($form.find('[name="'+a+'"]'))}),_addFormError($form,a)},this.markFormError=function(e){_addFormError($form,e)},this.enableValidation=function(){_clearMarker($form),settings.validationEnabled=!0},this.disableValidation=function(){_clearMarker($form),settings.validationEnabled=!1};var _addField=function(e,a){var i=null;switch(e){case"text":case"number":case"email":case"password":case"regex":case"typeahead":i=_defaultField(e,a);break;case"checkbox":i=_checkboxField(a);break;case"radio":i=_radioField(a);break;case"select":i=_selectField(a,!1);break;case"tags":i=_selectField(a,!0);break;case"color":i=_defaultAddonField("color",a);break;case"date":i=_defaultAddonField("date",a);break;case"time":i=_defaultAddonField("time",a);break;case"longtext":i=_textareaField(a);break;case"wysiwyg":i=_wysiwygField(a);break;case"button":i=_button(a);break;case"file":i=_file(a);break;case"image":i=_image(a)}return i},_addColumns=function(e,n){var t=$("<div></div>");return t.addClass("row"),$.each(e,function(e,a){var i=$("<div></div>");i.addClass("col-md-6"),a.data&&(i.append(_addField(a.type,a.data)),null===_findInArray(a.data.name,n)&&n.push({name:a.data.name,binding:""})),t.append(i)}),t},_bind=function(n,t,r,d){var s,l=n.find('[name="'+r+'"]');l&&void 0!==t[d]&&(void 0===(s=l.prop("type"))&&(s=l.attr("type")),n.on("change",l,function(e,a){var i;if(l.attr("name")===$(e.target).attr("name"))switch(s){case"checkbox":i=l.is(":checked")?1:0,t[d]=i;break;case"radio":i=n.find('input[name="'+r+'"]:checked').val(),t[d]=i;break;case"select":$(e.target).hasClass("tags")||(i=n.find('select[name="'+r+'"] option:selected').val(),t[d]=i);break;case"wysiwyg":i=n.find('div[name="'+r+'"]').html(),t[d]=i;break;case"file":t[d]=l.prop("files"),n.find("div.file-list").children(".file").remove(),$.each(l.prop("files"),function(e,a){var a=a.name.replace(/\\/g,"/").replace(/.*\//,""),i=$("<div></div>");i.addClass("file"),i.attr("data-filename",a),i.append('<span class="filename">'+a+"</span>"),i.append('<span class="delete"><i class="fa fa-trash"></i></span>'),n.find("div.file-list").append(i)});break;default:t[d]=l.val()}}),_updateFieldData(l,t,d))},_validate=function(r,e){_clearMarker(r);var d=!0;return settings.validationEnabled&&($.each(e,function(e,a){var i,n=r.find('[name="'+a.name+'"]'),a=n.prop("type"),t=(void 0===a&&(a=n.attr("type")),n.val());if("wysiwyg"===a&&(t=n.html()),_hasAttribute(n,"required"))switch(a){case"radio":!1===n.is(":checked")&&(d=!1,_addFieldError(n));break;case"checkbox":t&&!1!==n.prop("checked")||(d=!1,_addFieldError(n));break;case"select-one":t&&"0"!=t||(d=!1,_addFieldError(n));break;default:t||(d=!1,_addFieldError(n))}else"radio"==a&&n.closest("div").hasClass("required")&&!1===n.is(":checked")&&(d=!1,_addFieldError(n));switch(a){case"number":t&&!$.isNumeric(t)&&(d=!1,_addFieldError(n));break;case"email":i=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,t&&!i.test(t)&&(d=!1,_addFieldError(n))}a=n.attr("data-regex");a&&(i=new RegExp(a),t&&!i.test(t)&&(d=!1,_addFieldError(n)))}),d||_addFormError(r)),d},_createGroupAddon=function(e){var a=$("<span></span>");return a.addClass("input-group-addon"),"time"===e?a.html('<i class="fa fa-clock-o"></i>'):"date"===e?a.html('<i class="fa fa-calendar"></i>'):a.html("<i></i>"),a},_addLabel=function(e,a){var i=a.label;return settings.showRequiredAsterisk&&a.required&&(i+="<span class='required-sign'>*</span>"),e.append("<label class='control-label'>"+i+":</label>"),e},_addNeededOptions=function(e,a){return a.css&&(e=e.slice(0,-1),e+=" "+a.css+"'"),a.placeholder&&(e+=" placeholder='"+a.placeholder+"'"),a.attributes&&(e+=" "+a.attributes),a.required&&(e+=" required"),a.regex&&(e+=" data-regex='"+a.regex+"'"),a.elemdata&&(e+=" data-elemdata='"+JSON.stringify(a.elemdata)+"'"),e},_defaultField=function(e,a){var i=$("<div></div>"),e=(i.addClass("form-group"),i=_addLabel(i,a),"<input type='"+e+"' name='"+a.name+"' class='form-control'"),e=_addNeededOptions(e,a);return i.append(e+=" />"),i},_defaultAddonField=function(e,a){var i=$("<div></div>"),n=(i.addClass("form-group"),i.addClass("addon"),i=_addLabel(i,a),$("<div></div>")),t=(n.addClass("input-group "+e),"<input type='text' name='"+a.name+"' class='form-control'"),a=("date"===e&&(t+=" data-date-format='"+a.format+"'"),t=_addNeededOptions(t,a),t+=" />",_createGroupAddon(e));return n.append(t),n.append(a),i.append(n),i},_checkboxField=function(e){var a=$("<div></div>"),i=(a.addClass("checkbox"),$("<label></label>")),n=(i.addClass("control-label"),"<input type='checkbox' name='"+e.name+"'"),n=_addNeededOptions(n,e),n=(i.append(n+=" />"),e.label);return settings.showRequiredAsterisk&&e.required&&(n+="<span class='required-sign'>*</span>"),i.append(n),a.append(i),a},_radioField=function(e){var a=$("<div></div>"),i=(a.addClass("radio"),$("<label></label>")),n=(i.addClass("control-label"),"<input type='radio' name='"+e.name+"'"),n=(e.value&&(n+=" value='"+e.value+"'"),n=_addNeededOptions(n,e),i.append(n+=" />"),e.label);return settings.showRequiredAsterisk&&e.required&&(n+="<span class='required-sign'>*</span>"),i.append(n),a.append(i),a},_selectField=function(e,a){var i=$("<div></div>"),n=(i.addClass("form-group"),i=_addLabel(i,e),"'form-control'"),t=(a&&(n="'form-control tags chosen-select' multiple",e.placeholder&&(n+=" data-placeholder='"+e.placeholder+"'")),"<select type='select' name='"+e.name+"' class="+n);return e.css&&(t=input.slice(0,-1),t+=" "+e.css+"'"),e.attributes&&(t+=" "+e.attributes),e.required&&(t+=" required"),t+=">",e.placeholder&&!a&&(t+="<option value='0' disabled selected>"+e.placeholder+"</option>"),e.options&&$.each(e.options,function(e,a){t+="<option value='"+a.id+"'",a.type&&(t+=" data-type='"+a.type+"'"),t+=">"+a.name+"</option>"}),e.url&&$.ajax({type:"GET",url:e.url,dataType:"json",async:!1,success:function(e){JSON.parse(JSON.stringify(e.result)).forEach(function(e){Object.hasOwn(e,"Id")&&Object.hasOwn(e,"Name")?(t+="<option value='"+e.Id+"'",e.Type&&(t+=" data-type='"+e.Type+"'"),t+=">"+e.Name+"</option>"):Object.hasOwn(e,"id")&&Object.hasOwn(e,"name")&&(t+="<option value='"+e.id+"'",e.type&&(t+=" data-type='"+e.type+"'"),t+=">"+e.name+"</option>")})},error:function(e,a){console&&console.log("tiejs: error loading select options from server, status: "+a)}}),t+="</select>",i.append(t),i},_textareaField=function(e){var a=$("<div></div>"),i=(a.addClass("form-group"),a=_addLabel(a,e),"<textarea type='textarea' name='"+e.name+"' class='form-control'"),i=_addNeededOptions(i,e);return a.append(i+="></textarea>"),a},_wysiwygField=function(e){var a=$("<div></div>"),i=(a.addClass("form-group"),a=_addLabel(a,e),"<div type='wysiwyg' name='"+e.name+"' class='form-control wysiwyg'"),i=_addNeededOptions(i,e);return a.append(i+="></div>"),a},_button=function(e){var a=$("<div></div>"),i=(a.addClass("form-group"),"<button type='button' class='btn btn-default'");return e.css&&(i=i.slice(0,-1),i+=" "+e.css+"'"),i+=">"+e.label+"</button>",a.append(i),e.clickCB&&(i=a.find("button"),$(i).on("click",e.clickCB)),a},_file=function(n){var e=$("<div></div>"),a=(e.addClass("form-group dropzone"),e=_addLabel(e,n),"<div class='drop-area'><div class='action'>Click to browse or drop files here</div>"),i=(a+="<input type='file' name='"+n.name+"'",n.accept&&(a+=" accept='"+n.accept+"'"),n.required&&(a+=" required"),n.multi&&(a+=" multiple"),a+=" style='display:none'/>",$("<div></div>"));return i.addClass("file-list"),n.clearable&&i.addClass("deletable"),e.append(a),e.append(i),$(document).off("click",".dropzone .drop-area .action").on("click",".dropzone .drop-area .action",function(){$(this).parent().find(":file").click()}),$(document).off("dragenter dragover",".dropzone .drop-area").on("dragenter dragover",".dropzone .drop-area",function(e){e.stopPropagation(),e.preventDefault()}),$(document).off("drop",".dropzone .drop-area").on("drop",".dropzone .drop-area",function(e){if(e.originalEvent.dataTransfer&&e.originalEvent.dataTransfer.files.length){e.stopPropagation(),e.preventDefault();var a=[];n.multi?a.push(...e.originalEvent.dataTransfer.files):(e=e.originalEvent.dataTransfer.files[0],a.push(e));let i=new DataTransfer;$.each(a,function(e,a){i.items.add(a)}),$form.find('input[name="'+n.name+'"]')[0].files=i.files,$form.find('input[name="'+n.name+'"]').trigger("change")}}),$(document).off("click",".dropzone .file-list .file .delete").on("click",".dropzone .file-list .file .delete",function(){const a=$(this).parent().attr("data-filename");var e=Array.from($form.find('input[name="'+n.name+'"]')[0].files).filter(e=>e.name!==a);let i=new DataTransfer;$.each(e,function(e,a){i.items.add(a)}),0===e.length&&n.clearable&&n.clearable(),$form.find('input[name="'+n.name+'"]')[0].files=i.files,$form.find('input[name="'+n.name+'"]').trigger("change")}),e},_image=function(e){var a=$("<div></div>"),i=(a.addClass("form-group"),a=_addLabel(a,e),$("<div></div>")),e=(i.addClass("fileinput fileinput-new"),i.prop("data-provides","fileinput"),"<div class='fileinput-button'><span class='btn btn-default btn-file'><span class='fileinput-new'>"+e.selectLabel+"</span><span class='fileinput-exists'>"+e.changeLabel+"</span><input type='file' class='image' id='"+e.name+"' name='"+e.name+"' accept='image/jpeg, image/png, image/gif'/></span><a href='javascript:void()' class='btn btn-default fileinput-exists fileinput-delete' data-dismiss='fileinput'>"+e.removeLabel+"</a></div>");return i.append("<div class='fileinput-preview thumbnail' data-trigger='fileinput'></div>").append(e),a.append(i),a};function _clearMarker(e){e.find("div.alert").remove(),e.find(".error-message").hide(),e.find(".has-error").each(function(e,a){$(a).removeClass("has-error has-feedback"),$(a).find(".form-control-feedback").remove()})}function _hasAttribute(e,a){e=$(e).attr(a);return void 0!==e&&!1!==e}function _addFormError(e,a){var i=$(".formerror");0===i.length&&((i=$("<div></div>")).addClass("formerror alert alert-danger"),e.prepend(i)),void 0===a?i.text(settings.globalValidationFailedText):i.text(a)}function _addFieldError(e){var a=e.is(":radio")?e.closest("div"):e.parent();(a=a.hasClass("input-group")?a.parent():a).addClass("has-error has-feedback"),e.is("select")?a.append("<span class='fa fa-times form-control-feedback feedback-select'></span>"):e.is(":checkbox")?a.append("<span class='fa fa-times form-control-feedback feedback-checkbox'></span>"):e.is(":radio")?a.append("<span class='fa fa-times form-control-feedback feedback-radio'></span>"):a.append("<span class='fa fa-times form-control-feedback'></span>"),a.find(".error-message").show().css("display","block")}function _updateFieldData(i,n,t){var a,r,e,d=i.prop("type");switch(d=void 0===d?i.attr("type"):d){case"checkbox":n[t]?i.prop("checked",!0):i.prop("checked",!1);break;case"radio":i.val([n[t]]);break;case"select":$(i).hasClass("tags")?(a=[],n[t].forEach(function(e){a.push(e)}),i.val(a)):(r=i.find("option")).each(function(e){var a=$(r[e]).attr("data-type");a?a===n[t]&&i.val($(r[e]).val()):$(r[e]).val()===n[t]&&i.val($(r[e]).val())});break;case"select-one":var s=i.find("option");s.each(function(e){var a=$(s[e]).attr("data-type");a?a===n[t]&&i.val($(s[e]).val()):$(s[e]).val()===n[t]&&i.val($(s[e]).val())});break;case"select-multiple":var l=[];n[t].forEach(function(e){l.push(e)}),i.val(l);break;case"wysiwyg":i.html(n[t]),i.trigger("change");break;case"file":$(i).prop("multiple")?n[t].forEach(function(e){e=_createFileElement(e);i.closest(".drop-area").siblings("div.file-list").append(e)}):(e=n[t])&&(e=_createFileElement(e),i.closest(".drop-area").siblings("div.file-list").append(e));break;default:i.val(n[t])}}function _createFileElement(e){var a=$("<div></div>");return a.addClass("file"),a.attr("data-filename",e.fileName),a.append('<span class="filename">'+e.fileName+"</span>"),a.append('<span class="delete"><i class="fa fa-trash"></i></span>'),a}function _findInArray(e,a){for(var i=0;i<a.length;i++){var n=a[i];if(n.name===e)return n}return null}};$.fn.TieJS=function(a){return this.each(function(){var e=$(this);e.data("tiejs")||e.data("tiejs",new TieJS(this,a))})}});