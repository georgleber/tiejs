/*!
 TieJS - https://georghenkel.github.io/tiejs/
 Licensed under the MIT license
 Copyright (c) 2018 Georg Leber <g.leber@cg-solutions.de>, Christoph Huppertz <c.huppertz@cg-solutions.de>
 */
!function(a){"use strict";"function"==typeof define&&define.amd?define(["jquery"],a):a(jQuery)}(function($){"use strict";var TieJS=function(form,options){function _initForm(){if(settings.formName&&$form.attr("name",settings.formName),settings.showRequiredAsterisk){var a=$("<p class='required-info'>"+settings.requiredText+"</p>");$form.prepend(a)}$form.addClass("tiejs-form"),$form.on("submit",function(a){a.preventDefault(),_validate($form,fieldNames)&&settings.onSubmit($form)})}function _clearMarker(a){a.find("div.alert").remove(),a.find(".error-message").hide(),a.find(".has-error").each(function(a,b){$(b).removeClass("has-error has-feedback"),$(b).find(".form-control-feedback").remove()})}function _hasAttribute(a,b){var c=$(a).attr(b);return void 0!==c&&!1!==c}function _addFormError(a,b){var c=$(".formerror");0===c.length&&(c=$("<div></div>"),c.addClass("formerror alert alert-danger"),a.prepend(c)),void 0===b?c.text(settings.globalValidationFailedText):c.text(b)}function _addFieldError(a){var b=a.is(":radio")?a.closest("div"):a.parent();b.hasClass("input-group")&&(b=b.parent()),b.addClass("has-error has-feedback"),a.is("select")?b.append("<span class='fa fa-times form-control-feedback feedback-select'></span>"):a.is(":checkbox")?b.append("<span class='fa fa-times form-control-feedback feedback-checkbox'></span>"):a.is(":radio")?b.append("<span class='fa fa-times form-control-feedback feedback-radio'></span>"):b.append("<span class='fa fa-times form-control-feedback'></span>"),b.find(".error-message").show().css("display","block")}function _updateFieldData(a,b,c){var d=a.prop("type");switch(void 0===d&&(d=a.attr("type")),d){case"checkbox":b[c]?a.prop("checked",!0):a.prop("checked",!1);break;case"radio":a.val([b[c]]);break;case"select":if($(a).hasClass("tags")){var e=[];b[c].forEach(function(a){e.push(a)}),a.val(e)}else{var f=a.find("option");f.each(function(d){var e=$(f[d]).attr("data-type");e?e===b[c]&&a.val($(f[d]).val()):$(f[d]).val()===b[c]&&a.val($(f[d]).val())})}break;case"select-one":var g=a.find("option");g.each(function(d){var e=$(g[d]).attr("data-type");e?e===b[c]&&a.val($(g[d]).val()):$(g[d]).val()===b[c]&&a.val($(g[d]).val())});break;case"select-multi":var h=[];b[c].forEach(function(a){h.push(a)}),a.val(h);break;case"wysiwyg":a.html(b[c]),a.trigger("change");break;case"file":a.wrap("<form>").closest("form").get(0).reset(),a.unwrap(),$form.find("input[name="+a.prop("name")+"_label]").val(b[c]);break;default:a.val(b[c])}}function _findInArray(a,b){for(var c=0;c<b.length;c++){var d=b[c];if(d.name===a)return d}return null}var self=$(this),$form=$(form),fieldNames=[],settings=$.extend({showRequiredAsterisk:!0,requiredText:"Mit <span class='required-sign'>*</span> markierte Felder sind Pflichtfelder.",formName:null,validationEnabled:!0,globalValidationFailedText:"Bitte beheben Sie die im Formular hervorgehobenen Fehler.",bindingSource:{},onSubmit:function(){}},options);_initForm(),this.addFields=function(a){return $.each(a,function(a,b){b.data&&($form.append(_addField(b.type,b.data)),null===_findInArray(b.data.name,fieldNames)&&fieldNames.push({name:b.data.name,binding:""}))}),this},this.addColumns=function(a){return a.length>0&&$form.append(_addColumns(a,fieldNames)),this},this.addBindings=function(bindings){return settings.bindingSource&&$.each(bindings,function(index,binding){$.each(binding,function(fieldName,property){var binding=settings.bindingSource;if(-1!=property.indexOf(".")){var lastPointIdx=property.lastIndexOf("."),namespace=property.substr(0,lastPointIdx);property=property.substr(lastPointIdx+1);var tmp="settings.bindingSource."+namespace;binding=eval(tmp)}_bind($form,binding,fieldName,property);var fieldNameData=_findInArray(fieldName,fieldNames);fieldNameData.binding=property})}),this},this.captureFields=function(){return $form.find(":input:not(:button)").each(function(a,b){var c=$(b).attr("name");null===_findInArray(c,fieldNames)&&fieldNames.push({name:c,binding:""})}),this},this.updateSettings=function(a){$.extend(settings,a),this.reload()},this.reload=function(){_clearMarker($form),$.each(fieldNames,function(a,b){_bind($form,settings.bindingSource,b.name,b.binding)})},this.markFieldError=function(a,b){$.each(a,function(a,b){_addFieldError($form.find("[name="+b+"]"))}),_addFormError($form,b)},this.markFormError=function(a){_addFormError($form,a)},this.enableValidation=function(){_clearMarker($form),settings.validationEnabled=!0},this.disableValidation=function(){_clearMarker($form),settings.validationEnabled=!1};var _addField=function(a,b){var c=null;switch(a){case"text":case"number":case"email":case"password":case"regex":case"typeahead":c=_defaultField(a,b);break;case"checkbox":c=_checkboxField(b);break;case"radio":c=_radioField(b);break;case"select":c=_selectField(b,!1);break;case"tags":c=_selectField(b,!0);break;case"color":c=_defaultAddonField("color",b);break;case"date":c=_defaultAddonField("date",b);break;case"time":c=_defaultAddonField("time",b);break;case"longtext":c=_textareaField(b);break;case"wysiwyg":c=_wysiwygField(b);break;case"button":c=_button(b);break;case"file":c=_file(b)}return c},_addColumns=function(a,b){var c=$("<div></div>");return c.addClass("row"),$.each(a,function(a,d){var e=$("<div></div>");e.addClass("col-md-6"),d.data&&(e.append(_addField(d.type,d.data)),null===_findInArray(d.data.name,b)&&b.push({name:d.data.name,binding:""})),c.append(e)}),c},_bind=function(a,b,c,d){var e=a.find("[name="+c+"]");if(e&&void 0!==b[d]){var f=e.prop("type");void 0===f&&(f=e.attr("type")),a.on("change",e,function(g,h){if(e.attr("name")===$(g.target).attr("name")){var i;switch(f){case"checkbox":i=e.is(":checked")?1:0,b[d]=i;break;case"radio":i=a.find("input[name="+c+"]:checked").val(),b[d]=i;break;case"select":$(g.target).hasClass("tags")||(i=a.find("select[name="+c+"] option:selected").val(),b[d]=i);break;case"wysiwyg":i=a.find("div[name="+c+"]").html(),b[d]=i;break;case"file":b[d]=e.prop("files")[0];var j=e.val().replace(/\\/g,"/").replace(/.*\//,"");a.find("input[name="+c+"_label]").val(j);break;default:b[d]=e.val()}}}),_updateFieldData(e,b,d)}},_validate=function(a,b){_clearMarker(a);var c=!0;return settings.validationEnabled?($.each(b,function(b,d){var e=a.find("[name="+d.name+"]"),f=e.prop("type");void 0===f&&(f=e.attr("type"));var g=e.val();if("wysiwyg"===f&&(g=e.html()),_hasAttribute(e,"required"))switch(f){case"radio":!1===e.is(":checked")&&(c=!1,_addFieldError(e));break;case"checkbox":g&&!1!==e.prop("checked")||(c=!1,_addFieldError(e));break;case"select-one":g&&"0"!=g||(c=!1,_addFieldError(e));break;default:g||(c=!1,_addFieldError(e))}else"radio"==f&&e.closest("div").hasClass("required")&&!1===e.is(":checked")&&(c=!1,_addFieldError(e));var h;switch(f){case"number":g&&!$.isNumeric(g)&&(c=!1,_addFieldError(e));break;case"email":h=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,g&&!h.test(g)&&(c=!1,_addFieldError(e))}var i=e.attr("data-regex");i&&(h=new RegExp(i),g&&!h.test(g)&&(c=!1,_addFieldError(e)))}),c||_addFormError(a),c):c},_createGroupAddon=function(a){var b=$("<span></span>");return b.addClass("input-group-addon"),"time"===a?b.html('<i class="fa fa-clock-o"></i>'):"date"===a?b.html('<i class="fa fa-calendar"></i>'):b.html("<i></i>"),b},_addLabel=function(a,b){var c=b.label;return settings.showRequiredAsterisk&&b.required&&(c+="<span class='required-sign'>*</span>"),a.append("<label class='control-label'>"+c+":</label>"),a},_addNeededOptions=function(a,b){return b.css&&(a=a.slice(0,-1),a+=" "+b.css+"'"),b.placeholder&&(a+=" placeholder='"+b.placeholder+"'"),b.attributes&&(a+=" "+b.attributes),b.required&&(a+=" required"),b.regex&&(a+=" data-regex='"+b.regex+"'"),b.elemdata&&(a+=" data-elemdata='"+JSON.stringify(b.elemdata)+"'"),a},_defaultField=function(a,b){var c=$("<div></div>");c.addClass("form-group"),c=_addLabel(c,b);var d="<input type='"+a+"' name='"+b.name+"' class='form-control'";return d=_addNeededOptions(d,b),d+=" />",c.append(d),c},_defaultAddonField=function(a,b){var c=$("<div></div>");c.addClass("form-group"),c.addClass("addon"),c=_addLabel(c,b);var d=$("<div></div>");d.addClass("input-group "+a);var e="<input type='text' name='"+b.name+"' class='form-control'";"date"===a&&(e+=" data-date-format='"+b.format+"'"),e=_addNeededOptions(e,b),e+=" />";var f=_createGroupAddon(a);return d.append(e),d.append(f),c.append(d),c},_checkboxField=function(a){var b=$("<div></div>");b.addClass("checkbox");var c=$("<label></label>");c.addClass("control-label");var d="<input type='checkbox' name='"+a.name+"'";d=_addNeededOptions(d,a),d+=" />",c.append(d);var e=a.label;return settings.showRequiredAsterisk&&a.required&&(e+="<span class='required-sign'>*</span>"),c.append(e),b.append(c),b},_radioField=function(a){var b=$("<div></div>");b.addClass("radio");var c=$("<label></label>");c.addClass("control-label");var d="<input type='radio' name='"+a.name+"'";a.value&&(d+=" value='"+a.value+"'"),d=_addNeededOptions(d,a),d+=" />",c.append(d);var e=a.label;return settings.showRequiredAsterisk&&a.required&&(e+="<span class='required-sign'>*</span>"),c.append(e),b.append(c),b},_selectField=function(a,b){var c=$("<div></div>");c.addClass("form-group"),c=_addLabel(c,a);var d="'form-control'";b&&(d="'form-control tags chosen-select' multiple",a.placeholder&&(d+=" data-placeholder='"+a.placeholder+"'"));var e="<select type='select' name='"+a.name+"' class="+d;return a.css&&(e=input.slice(0,-1),e+=" "+a.css+"'"),a.attributes&&(e+=" "+a.attributes),a.required&&(e+=" required"),e+=">",a.placeholder&&!b&&(e+="<option value='0' disabled selected>"+a.placeholder+"</option>"),a.options&&$.each(a.options,function(a,b){e+="<option value='"+b.id+"'",b.type&&(e+=" data-type='"+b.type+"'"),e+=">"+b.name+"</option>"}),a.url&&$.ajax({type:"GET",url:a.url,dataType:"json",async:!1,success:function(a){JSON.parse(JSON.stringify(a.result)).forEach(function(a){e+="<option value='"+a.Id+"'",a.Type&&(e+=" data-type='"+a.Type+"'"),e+=">"+a.Name+"</option>"})},error:function(a,b){console&&console.log("tiejs: error loading select options from server, status: "+b)}}),e+="</select>",c.append(e),c},_textareaField=function(a){var b=$("<div></div>");b.addClass("form-group"),b=_addLabel(b,a);var c="<textarea type='textarea' name='"+a.name+"' class='form-control'";return c=_addNeededOptions(c,a),c+="></textarea>",b.append(c),b},_wysiwygField=function(a){var b=$("<div></div>");b.addClass("form-group"),b=_addLabel(b,a);var c="<div type='wysiwyg' name='"+a.name+"' class='form-control wysiwyg'";return c=_addNeededOptions(c,a),c+="></div>",b.append(c),b},_button=function(a){var b=$("<div></div>");b.addClass("form-group");var c="<button type='button' class='btn btn-default'";if(a.css&&(c=c.slice(0,-1),c+=" "+a.css+"'"),c+=">"+a.label+"</button>",b.append(c),a.clickCB){var d=b.find("button");$(d).on("click",a.clickCB)}return b},_file=function(a){var b=$("<div></div>");b.addClass("form-group"),b=_addLabel(b,a);var c=$("<div></div>");c.addClass("input-group");var d="<label class='input-group-btn'><span class='btn btn-success'><i class='fa fa-folder-open'></i>"+a.buttonLabel+"<input type='file' name='"+a.name+"'";a.accept&&(d+=" accept='"+a.accept+"'"),a.required&&(d+=" required"),d+=" style='display:none'/></span></label>",c.append(d);var e="<input type='text' class='form-control' name='"+a.name+"_label'";return a.placeholder&&(e+=" placeholder='"+a.placeholder+"'"),e+="readonly/>",a.clearable&&(e+="<span class='input-group-btn'><span class='btn btn-danger clear-"+a.name+"'><i class='fa fa-trash'></i></span></span>",$(document).off("click",".clear-"+a.name).on("click",".clear-"+a.name,function(){a.clearable(),$form.find("input[name="+a.name+"_label]").val("")})),$(document).off("click","input[name="+a.name+"_label]").on("click","input[name="+a.name+"_label]",function(){$(this).parents(".input-group").find(":file").click()}),c.append(e),b.append(c),b}};$.fn.TieJS=function(a){return this.each(function(){var b=$(this);b.data("tiejs")||b.data("tiejs",new TieJS(this,a))})}});