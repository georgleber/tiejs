/*!
 TieJS - https://georghenkel.github.io/tiejs/
 Licensed under the MIT license
 Copyright (c) 2023 Georg Leber <g.leber@cg-solutions.de>, Christoph Huppertz <c.huppertz@cg-solutions.de>
 */
!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery"],e):e(jQuery)}(function($){"use strict";var TieJS=function(form,options){var self=$(this),$form=$(form),fieldNames=[],settings=$.extend({showRequiredAsterisk:!0,requiredText:"Mit <span class='required-sign'>*</span> markierte Felder sind Pflichtfelder.",formName:null,validationEnabled:!0,globalValidationFailedText:"Bitte beheben Sie die im Formular hervorgehobenen Fehler.",bindingSource:{},onSubmit:function(){}},options);function _initForm(){var e;settings.formName&&$form.attr("name",settings.formName),settings.showRequiredAsterisk&&(e=$("<p class='required-info'>"+settings.requiredText+"</p>"),$form.prepend(e)),$form.addClass("tiejs-form"),$form.on("submit",function(e){e.preventDefault(),_validate($form,fieldNames)&&settings.onSubmit($form)})}_initForm(),this.addFields=function(e){return $.each(e,function(e,a){a.data&&($form.append(_addField(a.type,a.data)),null===_findInArray(a.data.name,fieldNames))&&fieldNames.push({name:a.data.name,binding:""})}),this},this.addColumns=function(e){return 0<e.length&&$form.append(_addColumns(e,fieldNames)),this},this.addBindings=function(bindings){return settings.bindingSource&&$.each(bindings,function(index,binding){$.each(binding,function(fieldName,property){var binding=settings.bindingSource,lastPointIdx,namespace,tmp,binding,fieldNameData=(-1!==property.indexOf(".")&&(lastPointIdx=property.lastIndexOf("."),namespace=property.substr(0,lastPointIdx),property=property.substr(lastPointIdx+1),tmp="settings.bindingSource."+namespace,binding=eval(tmp)),_bind($form,binding,fieldName,property),_findInArray(fieldName,fieldNames));fieldNameData.binding=property})}),this},this.captureFields=function(){return $form.find(":input:not(:button)").each(function(e,a){a=$(a).attr("name");null===_findInArray(a,fieldNames)&&fieldNames.push({name:a,binding:""})}),this},this.updateSettings=function(e){$.extend(settings,e),this.reload()},this.reload=function(){_clearMarker($form),$.each(fieldNames,function(e,a){_bind($form,settings.bindingSource,a.name,a.binding)})},this.markFieldError=function(e,a){$.each(e,function(e,a){_addFieldError($form.find('[name="'+a+'"]'))}),_addFormError($form,a)},this.markFormError=function(e){_addFormError($form,e)},this.enableValidation=function(){_clearMarker($form),settings.validationEnabled=!0},this.disableValidation=function(){_clearMarker($form),settings.validationEnabled=!1};var _addField=function(e,a){var n=null;switch(e){case"text":case"number":case"email":case"password":case"regex":case"typeahead":n=_defaultField(e,a);break;case"checkbox":n=_checkboxField(a);break;case"radio":n=_radioField(a);break;case"select":n=_selectField(a,!1);break;case"tags":n=_selectField(a,!0);break;case"color":n=_defaultAddonField("color",a);break;case"date":n=_defaultAddonField("date",a);break;case"time":n=_defaultAddonField("time",a);break;case"longtext":n=_textareaField(a);break;case"wysiwyg":n=_wysiwygField(a);break;case"button":n=_button(a);break;case"file":n=_file(a);break;case"dropzone":n=_dropzone(a)}return n},_addColumns=function(e,t){var i=$("<div></div>");return i.addClass("row"),$.each(e,function(e,a){var n=$("<div></div>");n.addClass("col-md-6"),a.data&&(n.append(_addField(a.type,a.data)),null===_findInArray(a.data.name,t))&&t.push({name:a.data.name,binding:""}),i.append(n)}),i},_bind=function(r,d,s,o){var l,p=r.find('[name="'+s+'"]');p&&void 0!==d[o]&&(void 0===(l=p.prop("type"))&&(l=p.attr("type")),r.on("change",p,function(e,a){if(p.attr("name")===$(e.target).attr("name"))switch(l){case"checkbox":case"radio":n=p.is(":checked")?1:0,d[o]=n;break;case"select":$(e.target).hasClass("tags")||(n=r.find('select[name="'+s+'"] option:selected').val(),d[o]=n);break;case"wysiwyg":n=r.find('div[name="'+s+'"]').html(),d[o]=n;break;case"file":var n=p.parents(".dropzone"),t=p.parents(".file-upload");if(0<n.length){var n=$(n[0]).find("div.file-list").attr("data-url"),i=p.prop("files");let a=new FormData;p.prop("multiple")?[...i].forEach(e=>a.append("files[]",e)):a.append("files",i[0]),$.ajax({type:"POST",url:n,data:a,contentType:!1,processData:!1,success:e=>{e.forEach(e=>{p.prop("multiple")?d[o].push(e):d[o]=e}),_updateFieldData(p,d,o)},error:function(e){e=e.responseText&&JSON.parse(e.responseText).userMessage?JSON.parse(e.responseText).userMessage:e.statusText;_addFormError(r,e)}})}else 0<t.length&&(n=[...i=p.prop("files")].map(e=>e.name).join(", "),d[o]=i,d[o+"Name"]=n,_updateFieldData(p,d,o));break;default:d[o]=p.val()}}),_updateFieldData(p,d,o))},_validate=function(r,e){_clearMarker(r);var d=!0;return settings.validationEnabled&&($.each(e,function(e,a){var n,t=r.find('[name="'+a.name+'"]'),a=t.prop("type"),i=(void 0===a&&(a=t.attr("type")),t.val());if("wysiwyg"===a&&(i=t.html()),_hasAttribute(t,"required"))switch(a){case"radio":!1===t.is(":checked")&&(d=!1,_addFieldError(t));break;case"checkbox":i&&!1!==t.prop("checked")||(d=!1,_addFieldError(t));break;case"select-one":i&&"0"!=i||(d=!1,_addFieldError(t));break;default:i||(d=!1,_addFieldError(t))}else"radio"==a&&t.closest("div").hasClass("required")&&!1===t.is(":checked")&&(d=!1,_addFieldError(t));switch(a){case"number":i&&!$.isNumeric(i)&&(d=!1,_addFieldError(t));break;case"email":n=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,i&&!n.test(i)&&(d=!1,_addFieldError(t))}a=t.attr("data-regex");a&&(n=new RegExp(a),i)&&!n.test(i)&&(d=!1,_addFieldError(t))}),d||_addFormError(r)),d},_createGroupAddon=function(e){var a=$("<span></span>");return a.addClass("input-group-addon"),"time"===e?a.html('<i class="fa fa-clock-o"></i>'):"date"===e?a.html('<i class="fa fa-calendar"></i>'):a.html("<i></i>"),a},_addLabel=function(e,a){var n=a.label;return settings.showRequiredAsterisk&&a.required&&(n+="<span class='required-sign'>*</span>"),e.append("<label class='control-label'>"+n+":</label>"),e},_addNeededOptions=function(e,a){return a.css&&(e=e.slice(0,-1),e+=" "+a.css+"'"),a.placeholder&&(e+=" placeholder='"+a.placeholder+"'"),a.attributes&&(e+=" "+a.attributes),a.required&&(e+=" required"),a.regex&&(e+=" data-regex='"+a.regex+"'"),a.elemdata&&(e+=" data-elemdata='"+JSON.stringify(a.elemdata)+"'"),e},_defaultField=function(e,a){var n=$("<div></div>"),e=(n.addClass("form-group"),n=_addLabel(n,a),"<input type='"+e+"' name='"+a.name+"' class='form-control'"),e=_addNeededOptions(e,a);return n.append(e+=" />"),n},_defaultAddonField=function(e,a){var n=$("<div></div>"),t=(n.addClass("form-group"),n.addClass("addon"),n=_addLabel(n,a),$("<div></div>")),i=(t.addClass("input-group "+e),"<input type='text' name='"+a.name+"' class='form-control'"),a=("date"===e&&(i+=" data-date-format='"+a.format+"'"),i=_addNeededOptions(i,a),i+=" />",_createGroupAddon(e));return t.append(i),t.append(a),n.append(t),n},_checkboxField=function(e){var a=$("<div></div>"),n=(a.addClass("checkbox"),$("<label></label>")),t=(n.addClass("control-label"),"<input type='checkbox' name='"+e.name+"'"),t=_addNeededOptions(t,e),t=(n.append(t+=" />"),e.label);return settings.showRequiredAsterisk&&e.required&&(t+="<span class='required-sign'>*</span>"),n.append(t),a.append(n),a},_radioField=function(e){var a=$("<div></div>"),n=(a.addClass("radio"),$("<label></label>")),t=(n.addClass("control-label"),"<input type='radio' name='"+e.name+"'"),t=(e.value&&(t+=" value='"+e.value+"'"),t=_addNeededOptions(t,e),n.append(t+=" />"),e.label);return settings.showRequiredAsterisk&&e.required&&(t+="<span class='required-sign'>*</span>"),n.append(t),a.append(n),a},_selectField=function(e,a){var n=$("<div></div>"),t=(n.addClass("form-group"),n=_addLabel(n,e),"'form-control'"),i=(a&&(t="'form-control tags chosen-select' multiple",e.placeholder)&&(t+=" data-placeholder='"+e.placeholder+"'"),"<select type='select' name='"+e.name+"' class="+t);return e.css&&(i=input.slice(0,-1),i+=" "+e.css+"'"),e.attributes&&(i+=" "+e.attributes),e.required&&(i+=" required"),i+=">",e.placeholder&&!a&&(i+="<option value='0' disabled selected>"+e.placeholder+"</option>"),e.options&&$.each(e.options,function(e,a){i+="<option value='"+a.id+"'",a.type&&(i+=" data-type='"+a.type+"'"),i+=">"+a.name+"</option>"}),e.url&&$.ajax({type:"GET",url:e.url,dataType:"json",async:!1,success:function(e){JSON.parse(JSON.stringify(e.result)).forEach(function(e){Object.hasOwn(e,"Id")&&Object.hasOwn(e,"Name")?(i+="<option value='"+e.Id+"'",e.Type&&(i+=" data-type='"+e.Type+"'"),i+=">"+e.Name+"</option>"):Object.hasOwn(e,"id")&&Object.hasOwn(e,"name")&&(i+="<option value='"+e.id+"'",e.type&&(i+=" data-type='"+e.type+"'"),i+=">"+e.name+"</option>")})},error:function(e,a){console&&console.log("tiejs: error loading select options from server, status: "+a)}}),i+="</select>",n.append(i),n},_textareaField=function(e){var a=$("<div></div>"),n=(a.addClass("form-group"),a=_addLabel(a,e),"<textarea type='textarea' name='"+e.name+"' class='form-control'"),n=_addNeededOptions(n,e);return a.append(n+="></textarea>"),a},_wysiwygField=function(e){var a=$("<div></div>"),n=(a.addClass("form-group"),a=_addLabel(a,e),"<div type='wysiwyg' name='"+e.name+"' class='form-control wysiwyg'"),n=_addNeededOptions(n,e);return a.append(n+="></div>"),a},_button=function(e){var a=$("<div></div>"),n=(a.addClass("form-group"),"<button type='button' class='btn btn-default'");return e.css&&(n=n.slice(0,-1),n+=" "+e.css+"'"),n+=">"+e.label+"</button>",a.append(n),e.clickCB&&(n=a.find("button"),$(n).on("click",e.clickCB)),a},_dropzone=function(t){var e=$("<div></div>");e.addClass("form-group dropzone "+t.name),_addLabel(e,t);let a="<div class='drop-area'><div class='action'>"+t.browseLabel+"</div>";a+="<input type='file' name='"+t.name+"'",t.accept&&(a+=" accept='"+t.accept+"'"),t.required&&(a+=" required"),t.multi&&(a+=" multiple"),a+=" style='display:none'/>";var n=$("<div></div>");return n.addClass("file-list"),t.url&&n.attr("data-url",t.url),e.append(a),e.append(n),$(document).off("click",".dropzone."+t.name+" .drop-area .action").on("click",".dropzone."+t.name+" .drop-area .action",function(){$(this).parent().find(":file").click()}),$(document).off("dragenter dragover",".dropzone."+t.name+" .drop-area").on("dragenter dragover",".dropzone."+t.name+" .drop-area",function(e){e.stopPropagation(),e.preventDefault()}),$(document).off("drop",".dropzone."+t.name+" .drop-area").on("drop",".dropzone."+t.name+" .drop-area",function(e){if(e.originalEvent.dataTransfer&&e.originalEvent.dataTransfer.files.length){e.stopPropagation(),e.preventDefault();var a=[];t.multi?a.push(...e.originalEvent.dataTransfer.files):(e=e.originalEvent.dataTransfer.files[0],a.push(e));let n=new DataTransfer;$.each(a,function(e,a){n.items.add(a)}),$form.find('input[name="'+t.name+'"]')[0].files=n.files,$form.find('input[name="'+t.name+'"]').trigger("change")}}),$(document).off("click",".dropzone."+t.name+" .file-list .file .delete").on("click",".dropzone."+t.name+" .file-list .file .delete",function(){var e;$(this).parent().remove(),t.handleRemove&&(e=$(this).parent().attr("data-id"),t.handleRemove(e))}),e},_file=function(a){var e=$("<div></div>"),n=(e.addClass("form-group file-upload"),e=_addLabel(e,a),$("<div></div>")),t=(n.addClass("input-group fileinput fileinput-new"),n.prop("data-provides","fileinput"),$("<label></label>")),i=(t.addClass("input-group-btn btn-file"),t.append("<span class='btn btn-success'>"+a.selectLabel+"</span>"),a.multi?t.append("<input type='file' id='"+a.name+"' name='"+a.name+"' accept='"+a.accept+"' multiple=''/>"):t.append("<input type='file' id='"+a.name+"' name='"+a.name+"' accept='"+a.accept+"'/>"),$("<div></div>")),r=(i.addClass("form-control"),i.prop("data-trigger","fileinput"),i.append("<span class='fileinput-filename'></span>"),$("<span></span>"));return r.addClass("input-group-btn"),r.append("<span class='btn btn-danger fileinput-delete' data-dismiss='fileinput'><i class='far fa-trash-alt'></i></span>"),n.append(t),n.append(i),n.append(r),$(document).off("click",".file-upload .fileinput .fileinput-filename").on("click",".file-upload .fileinput .fileinput-filename",function(){$("#"+a.name).click()}),$(document).off("click",".file-upload .fileinput .fileinput-delete").on("click",".file-upload .fileinput .fileinput-delete",function(){var e=new DataTransfer;$("#"+a.name).files=e.files,$(this).parents(".file-upload").find(".fileinput-filename").text(""),a.handleRemove&&a.handleRemove()}),e.append(n),e};function _clearMarker(e){e.find("div.alert").remove(),e.find(".error-message").hide(),e.find(".has-error").each(function(e,a){$(a).removeClass("has-error has-feedback"),$(a).find(".form-control-feedback").remove()})}function _hasAttribute(e,a){e=$(e).attr(a);return void 0!==e&&!1!==e}function _addFormError(e,a){var n=$(".formerror");0===n.length&&((n=$("<div></div>")).addClass("formerror alert alert-danger"),e.prepend(n)),void 0===a?n.text(settings.globalValidationFailedText):n.text(a)}function _addFieldError(e){var a=e.is(":radio")?e.closest("div"):e.parent();(a=a.hasClass("input-group")?a.parent():a).addClass("has-error has-feedback"),e.is("select")?a.append("<span class='fa fa-times form-control-feedback feedback-select'></span>"):e.is(":checkbox")?a.append("<span class='fa fa-times form-control-feedback feedback-checkbox'></span>"):e.is(":radio")?a.append("<span class='fa fa-times form-control-feedback feedback-radio'></span>"):a.append("<span class='fa fa-times form-control-feedback'></span>"),a.find(".error-message").show().css("display","block")}function _updateFieldData(n,t,i){var a,r,e=n.prop("type");switch(e=void 0===e?n.attr("type"):e){case"checkbox":t[i]?n.prop("checked",!0):n.prop("checked",!1);break;case"radio":n.val([t[i]]);break;case"select":$(n).hasClass("tags")?(a=[],t[i].forEach(function(e){a.push(e)}),n.val(a)):(r=n.find("option")).each(function(e){var a=$(r[e]).attr("data-type");a?a===t[i]&&n.val($(r[e]).val()):$(r[e]).val()===t[i]&&n.val($(r[e]).val())});break;case"select-one":var d=n.find("option");d.each(function(e){var a=$(d[e]).attr("data-type");a?a===t[i]&&n.val($(d[e]).val()):$(d[e]).val()===t[i]&&n.val($(d[e]).val())});break;case"select-multiple":var s=[];t[i].forEach(function(e){s.push(e)}),n.val(s);break;case"wysiwyg":n.html(t[i]),n.trigger("change");break;case"file":var o=n.parents(".dropzone"),l=n.parents(".file-upload");if(0<o.length){const p=$(o[0]).find("div.file-list");p.children(".file").remove(),$(n).prop("multiple")?(o=t[i])&&0<o.length&&o.forEach(e=>p.append(_createFileElement(e))):(o=t[i])&&p.append(_createFileElement(o))}else 0<l.length&&(o=$(l[0]).find(".fileinput-filename"),l=t[i+"Name"],o.text(l));break;default:n.val(t[i])}}function _createFileElement(e){var a=_mapMimeTypeToIcon(e.mimeType),n=$("<div></div>");return n.addClass("file"),n.attr("data-id",e.id),n.append('<span class="icon"><i class="fa '+a+'"></i></span>'),n.append('<span class="filename">'+e.fileName+"</span>"),n.append('<span class="delete"><i class="fa fa-trash"></i></span>'),n}function _mapMimeTypeToIcon(e){let a="";switch(e){case"image/png":case"image/jpeg":case"image/gif":case"image/avif":case"image/webp":a="fa-file-image";break;case"application/pdf":a="fa-file-pdf";break;case"application/vnd.openxmlformats-officedocument.wordprocessingml.document":case"application/vnd.ms-word":a="fa-file-word";break;case"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":case"text/csv":case"application/vnd.ms-excel":a="fa-file-excel";break;case"application/zip":a="fa-file-archive";break;default:a="fa-file"}return a}function _findInArray(e,a){for(var n=0;n<a.length;n++){var t=a[n];if(t.name===e)return t}return null}};$.fn.TieJS=function(a){return this.each(function(){var e=$(this);e.data("tiejs")||e.data("tiejs",new TieJS(this,a))})}});